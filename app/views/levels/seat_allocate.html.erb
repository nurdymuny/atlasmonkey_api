<link href="http://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<h1 style="margin-left:0%; font-size:32px; color:black; font-weight: bold;">Seat Allocate</h1>

<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<% if @layout.present?
     # raise @layout.inspect
     @layout.each do |lay|
       @x_size = lay.grid_size.split('x')[0]
       @y_size = lay.grid_size.split('x')[1]
     end %>

    <span style=""><input type="hidden" id="rowcount" value="<%= @x_size %>" style="width: 3%;"/></span>
    <span style=""> <input type="hidden" id="columncount" value="<%= @y_size %>" style="width: 3%;"/></span><br><br>
<% else %>
    <span style="">Grid: <input type="text" id="rowcount" value="5" style="width: 3%;"/></span>
    <span style="">x <input type="text" id="columncount" value="5" style="width: 3%;"/></span><br><br>
<% end %>
<%= form_for @level, method: 'POST' do |f| %>
    <div class="field">

      <%= f.hidden_field :id %>
    </div>


<% end %>


<%= form_for @venue do |f| %>
    <%= f.hidden_field :id %>
<% end %>
<%= button_tag :Update, class: 'update_btn', onclick: 'add_new_table();' %>
<style>
    .update_btn {
        margin-left: 10%;
    }

    #rowcount {
        width: 6%;
    }

    #columncount {
        width: 6%;
    }

    select {
        width: 20%;
        height: 20px;
        border: 1px solid black;
    }

    .create_table {
        width: 91%;
        height: 700px;
        border: 1px solid black;
        margin-left: -4%;
        margin-top: 4%;
    }

    .td_cl_md {
        margin-top: 45px;
        border: 1px solid;
        background-color: white;
        width: 3% !important;
        height: 4%;

    }

    .td_cl_lg {
        margin-top: 45px;
        border: 1px solid;
        width: 1%;
        background-color: white;
        /*width: 5% !important;*/
        height: auto;

    }
</style>
<script>
    $(document).ready(function () {

//function createTable(){

        mytable = $('<table class="create_table sortable" id="text"></table>').attr({id: "basicTable"});
        var rows = Number($("#rowcount").val());
        var cols = Number($("#columncount").val());
        var tr = [];
        for (var i = 0; i < rows; i++) {
            var row = $('<tr></tr>').attr({class: ["class1", "class2", "c"].join(' ')}).appendTo(mytable);
            for (var j = 0; j < cols; j++) {
                var cell = '#' + i.toString() + j.toString();
                var cell_html = $(cell).html();
                if (cols > 20 && cell_html == undefined) {
                    $("<td  id='"+'x'+i.toString()+'y'+j.toString()+"'>").attr({class: ["td_cl_lg"]}).appendTo(row);
                }
                else {
                    $("<td  id='"+'x'+i.toString()+'y'+j.toString()+"'>").attr({class: ["td_cl_md"]}).appendTo(row);
                }
            }

        }
        // console.log("TTTTT:"+mytable.html());
        mytable.appendTo("#box");


    });
    $(".grid").keypress(function (e) {
        //if the letter is not digit then display error and don't type anything
        if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
            //display error message
            $("#errmsg").html("Digits Only").show().fadeOut(2000);
            return false;
        }
    });

</script>
<%
   @block_ids = @seat_layout.map(&:block_id).uniq
   index = 0
   color_block_id=Array.new()
   color = ['red','green','orange','blue','purple','grey','yellow']
   while index < @block_ids.length
     a=Hash.new()
     puts index
     puts @block_ids[index]
     a={'id'=> @block_ids[index], 'color'=> color[index]}
     color_block_id << a
     index += 1
   end
   # raise @seat_layout.inspect
   @seat_layout.each do |layout|
     @seat_layout_id = layout.id
     @x_grid_ref = layout.x_grid_ref
     @y_grid_ref = layout.y_grid_ref
     @seat_number = layout.seat_number
     @uuid_number = layout.uuid_number
     @block_id = layout.block_id
     @selected_block_color=color_block_id.find { |h| h['id'] == @block_id }['color']
     @blocks = Block.where(id: @block_id)
     # raise @blocks.inspect
     @blocks.each do |block|
       @block_name = block.name
%>
    <script>
        $(document).ready(function () {
            $("#<%= @x_grid_ref%><%= @y_grid_ref%>").addClass("td_cl_md");
            $("#<%= @x_grid_ref%><%= @y_grid_ref%>").removeClass("td_cl_lg");
            $("#<%= 'x'+@x_grid_ref.to_s%><%= 'y'+@y_grid_ref.to_s%>").html("<div style='height:100%; color:white; background-color:<%= @selected_block_color%>' ><span style='font-size:11px; font-weight:bold; position:relative; float:left;'><%= @block_name%></span><p style='margin-top: -2%; color:black; font-weight:500; font-size: 12px;'><span onclick='table_show(<%= @seat_number %>, <%= @seat_layout_id%>, \"<%= @uuid_number%>\");'><img src='/assetsTable2.png' id='img_<%= @x_grid_ref %><%= @y_grid_ref %>' width='15px' height='15px' style='margin-top: -7px;'  class='del_img' ></span><span class='seat_number' style= 'position: absolute; margin-top: 14px; font-size: 11px; margin-left:1px; color:white;'><%= @seat_number%></span><span><%- if @uuid_number.present?%><img src='/assetsibeacon2.png' width='20px' height='20px' style='float:left; position:absolute; margin-top:15px; margin-left:-30px;'/></span><% end%></div>");
            $("#<%= @x_grid_ref%><%= @y_grid_ref%>").css('background-color', '#C3C3C3');

        });
    </script>
<% end %>
<% end%>
<script>

    $(document).ready(function () {
        $(".draggable").draggable({
            helper: 'clone',
            revert: "invalid",

            create: function () {
                $(this).data('position', $(this).position())
            },
            cursorAt: {left: 15},
            cursor: 'move',
            start: function () {
                $(this).stop(true, true)
            },

        });

        $('#basicTable').find(".td_cl_md").droppable({

            drop: function (event, ui) {
                if (ui.draggable[0].id) {
                    $(this).append($(ui.helper).clone().draggable());
                }
                snapToMiddle(ui.draggable, $(this));
                var table_col_val = event.target.attributes[0].value;
//                        localStorage.setItem('table_col_val', table_col_val);
                currentList = localStorage["table_col_val"];
                var regId = [];
                console.log(currentList);
                if (currentList)
                    regId = JSON.parse(currentList);
                regId.push(table_col_val);
                localStorage['table_col_val'] = JSON.stringify(regId);
                $("#auto_fill").css("display", "block");
                console.log(table_col_val);
            }
        });
        $('#basicTable').find(".td_cl_lg").droppable({

            drop: function (event, ui) {
                if (ui.draggable[0].id) {
                    $(this).append($(ui.helper).clone().draggable());
                }
                snapToMiddle(ui.draggable, $(this));
                var table_col_val = event.target.attributes[0].value;
//                        localStorage.setItem('table_col_val', table_col_val);
                currentList = localStorage["table_col_val"];
                var regId = [];
                console.log(currentList);
                if (currentList)
                    regId = JSON.parse(currentList);
                regId.push(table_col_val);
                localStorage['table_col_val'] = JSON.stringify(regId);
                $("#auto_fill").css("display", "block");
                console.log(table_col_val);
            }
        });
        $("#img").draggable();


        $("#img").droppable({
            drop: function (event, ui) {
                ui.draggable.remove();
            }
        });
    });


    function snapToMiddle(dragger, target) {
//        var topMove = target.position().top - dragger.data('position').top + (target.outerHeight(true) - dragger.outerHeight(true)) / 2;
        var leftMove = target.position().left - dragger.data('position').left + (target.outerWidth(true) - dragger.outerWidth(true)) / 2;
        if (dragger[0].id == 'two_table') {
            var topMove = '20px';
            var table_number = "2";
        }
        else if (dragger[0].id == 'four_table') {
            var topMove = '58px';
            var table_number = "4";
        }
        else if (dragger[0].id == 'six_table') {
            var topMove = '95px';
            var table_number = "6";
        }
//                localStorage.setItem('table_number', table_number);
        currentList = localStorage["table_number"];
        var regId = [];
        console.log(currentList);
        if (currentList)
            regId = JSON.parse(currentList);
        regId.push(table_number);
        localStorage['table_number'] = JSON.stringify(regId);
        console.log(table_number);
        dragger.animate({top: topMove, left: leftMove}, {duration: 600, easing: 'easeOutBack'});
    }

    function boxsubmit() {
        var seat_number = $("#seat_number").val();
        var uuid_number = $("#uuid_number").val();
//        alert(uuid_number);
//                localStorage.setItem('table_number', table_number);
        currentList = localStorage["seat_number"];
        currentList - localStorage["uuid_number"];
        var regId = [];
        console.log(currentList);
        if (currentList)
            regId = JSON.parse(currentList);
        regId.push(seat_number);
        localStorage['seat_number'] = JSON.stringify(regId);
        $("#auto_fill").css("display", "none");
//                console.log(seat_number);
        $("#seat_number").val('');
        currentList = localStorage["uuid_number"];
        var UUID = [];
        console.log(currentList);
        if (currentList)
            UUID = JSON.parse(currentList);
        UUID.push(uuid_number);
        localStorage['uuid_number'] = JSON.stringify(UUID);
        console.log(uuid_number);
        $("#uuid_number").val('');

    }

    function update_box() {
        var restaurant_id = $("#layout_restaurants_id").val();
        var already_table_number = $("#already_value").val();
        var already_diner_id = $("#seat_layout_id").val();
        var user_id = $("#email_title").val();


//                localStorage.setItem('already_table_number', already_table_number);
//                localStorage.setItem('already_uuid_number', already_uuid_number);
        currentList = localStorage["already_table_number"];
        var regId = [];
        console.log(currentList);
        if (currentList)
            regId = JSON.parse(currentList);
        regId.push(already_table_number);
        localStorage['already_table_number'] = JSON.stringify(regId);

        currentList = localStorage["already_diner_id"];
        var regId = [];
        console.log(currentList);
        if (currentList)
            regId = JSON.parse(currentList);
        regId.push(already_diner_id);
        localStorage['already_diner_id'] = JSON.stringify(regId);

        $("#already_used").css("display", "none");
        $("#already_value").val('');

        currentList = localStorage["user_id"];
        var regId = [];
        console.log(currentList);
        if (currentList)
            regId = JSON.parse(currentList);
        regId.push(user_id);
        localStorage['user_id'] = JSON.stringify(regId);

        $("#user_id").val('');
    }

</script>
<script>
    function drag_poup_hide() {
        $("#auto_fill").css("display", "none");
        $("#seat_number").val('');
        $(".ui-draggable-dragging").css("display", "none");
        localStorage.clear();
    }

</script>
<script>
    function del_item(id) {
        var level_id = $("#level_id").val();
//        alert(id);
        var data = {seat_id: id, level_id: level_id};
        $.ajax({
            type: 'POST',
            url: '/levels/delete_record',
            data: data,
            success: function (response) {
                location.reload();
            }
        });
    }

</script>
<script>
    function add_new_table() {
        var already_table_number = JSON.parse(localStorage.getItem('already_table_number'));
        var already_diner_id = JSON.parse(localStorage.getItem('already_diner_id'));
        var user_id = JSON.parse(localStorage.getItem('user_id'));
        var level_id = $("#level_id").val();
        var venue_id = $("#venue_id").val();
        var block_id = $("#block_title").val();
//      alert(block_id);
        var table_col_val = JSON.parse(localStorage.getItem('table_col_val'));
        var seat_number = JSON.parse(localStorage.getItem('seat_number'));
        var uuid_number = JSON.parse(localStorage.getItem('uuid_number'));
        var x_grid = $("#rowcount").val();
        var y_grid = $("#columncount").val();
//      alert(x_grid);
        var data = {
            level_id: level_id,
            venue_id: venue_id,
            already_table_number: already_table_number,
            user_id: user_id
        };

        $.ajax({
            type: 'POST',
            url: '/levels/update_user_seat_layout',
            data: data,

            success: function (response) {
                localStorage.clear();
                console.log('ssss');
            }

        });
    }
</script>

<script>
    function table_show(seat_no, seat_layout_id, uuid_number) {
        $(".del_img").dblclick(function () {
            $("#already_used").css("display", "block");
            $("#already_value").val(seat_no);
            $("#already_uuid_number").val(uuid_number);
            $("#seat_layout_id").val(seat_layout_id);
            //localStorage.setItem('diner_id', diner_id);
        });
    }
</script>
<script>
    function stop_poup() {
        $("#already_used").css("display", "none");
        $("#already_value").val('');
    }
</script>
<script>
    function check_data(){
        var user_id = JSON.parse(localStorage.getItem('user_id'));
        if (user_id){
            alert('You have unsave data please save before leaving the page.');

        }else{
            javascript:history.back();
        }
    }
</script>

<div id="box">
  <div id="auto_fill" style="width: 18%; height: 145px; z-index: 9999; background-color: grey; display: none; position:absolute; margin-top: 10%; margin-left: 10%; border-radius:5px;">
    <form name="fname" method="post">
      &nbsp;&nbsp;<span style="color: black; font-weight:bold;">Enter Seat No.</span><input type="text" id="seat_number" style="margin-left: 5%; margin-top: 5%;" required="required">
      &nbsp;&nbsp;<span style="color: black; font-weight:bold;">Enter UID: </span><input type="text" id="uuid_number" required="required" style="margin-left: 5%; margin-top: 5%;">
      <span onclick="drag_poup_hide();"><img src="/assetsclose.png" style="width: 7%; position: absolute; top:-1%; right:1%; cursor: pointer;"></span><br>
      <input type="button" value="Submit" style="margin-left: 33%; margin-top: 8%; background-color: #337ab7; color: white; border: 1px solid black; border-radius: 5px;" onclick="boxsubmit();">
    </form>

  </div>
  <div id="already_used" style="width: 20%; height: 150px; z-index: 9999; background-color: grey; display: none; position:absolute; margin-top: 10%; margin-left: 10%; border-radius:5px;">
    <form name="fnme" method="post">
      &nbsp;&nbsp;<span style="color: black; font-weight:bold;">Seat No.</span><input type="text" id="already_value" style="margin-left: 5%; margin-top: 5%;" readonly="readonly" required="required"><span onclick="stop_poup();"><img src="/assetsclose.png" style="width: 7%; position: absolute; top:-1%; right:1%; cursor: pointer;"></span><br>
      &nbsp;&nbsp;<span style="color: black; font-weight:bold;">User Name:
      &nbsp;&nbsp;<%= collection_select(:email, :title, User.where('is_admin= 0'), :id, :email, {:prompt => 'Please select user', :required => true}, {:class => 'user_seat_allocate'}) %></span>
      <input type="hidden" id="seat_layout_id">
      <input type="button" value="Submit" style="margin-left: 33%; margin-top: 8%; background-color: #337ab7; color: white; border: 1px solid black; border-radius: 5px;" onclick="update_box();">
    </form>
  </div>
  <div style="float:right; margin-top:-21%;">
    <%= link_to "Go Back", 'javascript:history.back()', :onclick=> 'check_data(); return false;',class: "btn btn-primary" %>
  </div>
</div>
<style>
    .user_seat_allocate {
        width: 100%;
    }
</style>